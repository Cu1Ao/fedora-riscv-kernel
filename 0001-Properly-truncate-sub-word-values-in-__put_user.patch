From 0344ec4f5a4e39dd5108ca58c0c78d6f808ffcf2 Mon Sep 17 00:00:00 2001
From: Andrew Waterman <waterman@cs.berkeley.edu>
Date: Sun, 9 Oct 2016 14:59:10 -0700
Subject: [PATCH] Properly truncate sub-word values in __put_user

We need an explicit up-cast from char/short back to long, in order for
the sub-word quantity to be truncated.

h/t Richard W.M. Jones
---
 arch/riscv/include/asm/uaccess.h | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/riscv/include/asm/uaccess.h b/arch/riscv/include/asm/uaccess.h
index 9f9fba8..6eecd5b2 100644
--- a/arch/riscv/include/asm/uaccess.h
+++ b/arch/riscv/include/asm/uaccess.h
@@ -254,6 +254,7 @@ do {								\
 #define __put_user_asm(insn, x, ptr, err)			\
 do {								\
 	uintptr_t __tmp;					\
+	__typeof__(*(ptr)) __x = x;				\
 	__asm__ __volatile__ (					\
 		"1:\n"						\
 		"	" insn " %z3, %2\n"			\
@@ -269,14 +270,14 @@ do {								\
 		"	" PTR " 1b, 3b\n"			\
 		"	.previous"				\
 		: "+r" (err), "=r" (__tmp), "=m" (*(ptr))	\
-		: "rJ" (x), "i" (-EFAULT));			\
+		: "rJ" (__x), "i" (-EFAULT));			\
 } while (0)
 #else /* !CONFIG_MMU */
 #define __put_user_asm(insn, x, ptr, err)			\
 	__asm__ __volatile__ (					\
 		insn " %z1, %0"					\
 		: "=m" (*(ptr))					\
-		: "rJ" (x))
+		: "rJ" ((__typeof__(*(ptr))) x))
 #endif /* CONFIG_MMU */
 
 
-- 
2.9.3

